<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Linux驱动开发 字符设备 &#183; Can's Blog</title><meta name=title content="Linux驱动开发 字符设备 &#183; Can's Blog"><meta name=description content="Thoughts and conclusions about learning"><meta name=keywords content="Linux,驱动开发,"><link rel=canonical href=https://rycCJ.github.io/notes/linux%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91_%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87/><meta name=author content="Can"><link href=https://github.com/rycCJ rel=me><meta property="og:url" content="https://rycCJ.github.io/notes/linux%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91_%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87/"><meta property="og:site_name" content="Can's Blog"><meta property="og:title" content="Linux驱动开发 字符设备"><meta property="og:description" content="Thoughts and conclusions about learning"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="notes"><meta property="article:published_time" content="2025-11-17T15:53:29+08:00"><meta property="article:modified_time" content="2025-11-17T15:53:29+08:00"><meta property="article:tag" content="Linux"><meta property="article:tag" content="驱动开发"><meta name=twitter:card content="summary"><meta name=twitter:title content="Linux驱动开发 字符设备"><meta name=twitter:description content="Thoughts and conclusions about learning"><meta name=twitter:image content="https://rycCJ.github.io/img/lofi-girl-reading-book-while-its-raining-outside-pixel-moewalls-com-ezgif.com-video-to-gif-converter.gif"><meta property="og:image" content="https://rycCJ.github.io/img/lofi-girl-reading-book-while-its-raining-outside-pixel-moewalls-com-ezgif.com-video-to-gif-converter.gif"><link type=text/css rel=stylesheet href=/css/main.bundle.min.1149954ed9e0292a436554966ca4f8742eff113d3e32d4a884eaca322d0b4515643c173d5a812cd39a327f697ff3d28412276e5d199cdcbe3b1bbd2fd80e89f8.css integrity="sha512-EUmVTtngKSpDZVSWbKT4dC7/ET0+MtSohOrKMi0LRRVkPBc9WoEs05oyf2l/89KEEiduXRmc3L47G70v2A6J+A=="><script type=text/javascript src=/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.9cc802d09f28c6af56ceee7bc6e320a39251fdae98243f2a9942f221ac57a9f49c51609699a91794a7b2580ee1deaa8e4d794a68ffa94aa317c66e893ce51e02.js integrity="sha512-nMgC0J8oxq9Wzu57xuMgo5JR/a6YJD8qmULyIaxXqfScUWCWmakXlKeyWA7h3qqOTXlKaP+pSqMXxm6JPOUeAg==" data-copy=Copy data-copied=Copied></script><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Notes","name":"Linux驱动开发 字符设备","headline":"Linux驱动开发 字符设备","inLanguage":"en","url":"https:\/\/rycCJ.github.io\/notes\/linux%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91_%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87\/","author":{"@type":"Person","name":"Can"},"copyrightYear":"2025","dateCreated":"2025-11-17T15:53:29\u002b08:00","datePublished":"2025-11-17T15:53:29\u002b08:00","dateModified":"2025-11-17T15:53:29\u002b08:00","keywords":["Linux","驱动开发"],"mainEntityOfPage":"true","wordCount":"1820"}]</script></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class="main-menu flex items-center justify-between py-6 md:justify-start gap-x-3 pt-[2px] pr-2 md:pr-4 pb-[3px] pl-0"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium">Can&rsquo;s Blog</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/notes/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=Notes title=Notes><p class="text-base font-medium">Notes</p></a><a href=/posts/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=Posts title=Posts><p class="text-base font-medium">Posts</p></a><a href=https://github.com/rycCJ target=_blank class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=GitHub title><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span><p class="text-base font-medium">GitHub</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 me-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none text-end max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/notes/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=Notes title=Notes><p class="text-bg font-bg">Notes</p></a></li><li class=mt-1><a href=/posts/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=Posts title=Posts><p class="text-bg font-bg">Posts</p></a></li><li class=mt-1><a href=https://github.com/rycCJ target=_blank class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=GitHub title><div class=mr-2><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></div><p class="text-bg font-bg">GitHub</p></a></li></ul></div></div></div></div><script>(function(){var e=$(".main-menu"),t=window.location.pathname;e.find('a[href="'+t+'"]').each(function(e,t){$(t).children("p").addClass("active")})})()</script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div id=hero class="h-[150px] md:h-[200px]"></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"><img id=background-image src=/img/lofi-girl-reading-book-while-its-raining-outside-pixel-moewalls-com-ezgif.com-video-to-gif-converter.gif alt="Linux驱动开发 字符设备" loading=eager decoding=async fetchpriority=high class="absolute inset-0 w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script type=text/javascript src=/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=background-blur data-image-id=background-image data-image-url=/img/lofi-girl-reading-book-while-its-raining-outside-pixel-moewalls-com-ezgif.com-video-to-gif-converter.gif></script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Linux驱动开发 字符设备</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-11-17T15:53:29+08:00>17 November 2025</time><span class="px-2 text-primary-500">&#183;</span><span>1820 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">9 mins</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=views_notes/Linux驱动开发_字符设备.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full -mt-[2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=views>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentColor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span>
</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=likes_notes/Linux驱动开发_字符设备.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full -mt-[2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=likes>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></span>
</span><span class="px-2 text-primary-500">&#183;</span><span>
<button id=button_likes class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
<span id=button_likes_heart class="inline-block align-text-bottom hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span>
</span><span id=button_likes_emtpty_heart class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M244 84l11.1 12 12-11.98C300.6 51.37 347 36.51 392.6 44.1 461.5 55.58 512 115.2 512 185.1V190.9c0 41.5-17.2 81.2-47.6 109.5L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9S235.8 476.1 228.3 469.1L47.59 300.4C17.23 272.1.0 232.4.0 190.9V185.1c0-69.9 50.52-129.52 119.4-141 44.7-7.59 92 7.27 124.6 39.9C243.1 84 244 84.01 244 84zm11.1 79.9-45-46.8c-21.7-20.82-52.5-30.7-82.8-25.66C81.55 99.07 48 138.7 48 185.1V190.9c0 28.2 11.71 55.2 32.34 74.4L256 429.3l175.7-164c20.6-19.2 32.3-46.2 32.3-74.4V185.1c0-46.4-33.6-86.03-79.3-93.66C354.4 86.4 323.6 96.28 301.9 117.1l-46.8 46.8z"/></svg></span></span>
<span id=button_likes_text>&nbsp;Like</span></button></span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/tags/linux/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Linux
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">驱动开发</span></span></a></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full me-4" width=96 height=96 alt=Can src=/img/Can.jpg data-zoom-src=/img/Can.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Can</div><div class="text-sm text-neutral-700 dark:text-neutral-400">A little bit about you</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/rycCJ target=_blank aria-label=Github title=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs"><div class="toc ps-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#-核心概念什么是字符设备>🌟 核心概念：什么是字符设备？</a></li><li><a href=#-第一关传统功夫--手动打造字符设备驱动>🏗️ 第一关：传统功夫 —— 手动打造字符设备驱动</a><ul><li><ul><li><a href=#-通俗讲解>🗣️ 通俗讲解</a></li></ul></li><li><a href=#-代码实践>💻 代码实践</a></li></ul></li><li><a href=#-第二关自动挂牌--创建设备节点>🚪 第二关：自动挂牌 —— 创建设备节点</a><ul><li><a href=#-通俗讲解-1>🗣️ 通俗讲解</a></li><li><a href=#-代码实践-1>💻 代码实践</a></li></ul></li><li><a href=#-第三关数据搬运--用户与内核的交互>📦 第三关：数据搬运 —— 用户与内核的交互</a><ul><li><a href=#-通俗讲解-2>🗣️ 通俗讲解</a></li><li><a href=#-代码实践-2>💻 代码实践</a></li></ul></li><li><a href=#-第四关极简模式--杂项设备驱动-misc-device>🚀 第四关：极简模式 —— 杂项设备驱动 (Misc Device)</a><ul><li><a href=#-通俗讲解-3>🗣️ 通俗讲解</a></li><li><a href=#-代码实践-3>💻 代码实践</a></li></ul></li><li><a href=#-第五关高手进阶--私有数据与一驱多用>🧩 第五关：高手进阶 —— 私有数据与一驱多用</a><ul><li><a href=#-通俗讲解-4>🗣️ 通俗讲解</a></li><li><a href=#-通俗讲解全局变量-vs-私有数据>🏨 通俗讲解：全局变量 vs 私有数据</a><ul><li><a href=#1-全局变量的做法错误示范>1. 全局变量的做法（错误示范）</a></li><li><a href=#2-私有数据的做法private_data>2. 私有数据的做法（private_data）</a></li></ul></li><li><a href=#-代码实战多-app-数据隔离实验>💻 代码实战：多 APP 数据隔离实验</a><ul><li><a href=#1-驱动代码-private_data_drvc>1. 驱动代码 (<code>private_data_drv.c</code>)</a></li><li><a href=#2-测试应用程序-app_testc>2. 测试应用程序 (<code>app_test.c</code>)</a></li><li><a href=#-实验步骤见证奇迹的时刻>🧪 实验步骤（见证奇迹的时刻）</a></li><li><a href=#-为什么会这样底层逻辑>🔍 为什么会这样？（底层逻辑）</a></li></ul></li></ul></li><li><a href=#新增官方文档私有数据处理方法>新增：官方文档私有数据处理方法</a><ul><li><a href=#做法>做法</a></li><li><a href=#why为什么不直接用全局变量-dev1>why（为什么不直接用全局变量 <code>dev1</code>？）</a></li><li><a href=#优点>优点</a></li><li><a href=#区别对比表>区别对比表</a></li><li><a href=#场景还原如果两个-app-同时打开设备>场景还原：如果两个 APP 同时打开设备</a></li></ul></li><li><a href=#第六关使用-goto-跳转到错误处理处>第六关：使用 goto 跳转到错误处理处</a><ul><li><a href=#-通俗比喻>🏰 通俗比喻</a><ul><li><a href=#-如果没有错误处理耍流氓>❌ 如果没有错误处理（耍流氓）</a></li><li><a href=#-正确的错误处理倒叙撤销>✅ 正确的错误处理（倒叙撤销）</a></li></ul></li><li><a href=#-为什么要用-goto>🛠️ 为什么要用 <code>goto</code>？</a></li><li><a href=#-代码实战带错误处理的驱动框架>💻 代码实战：带错误处理的驱动框架</a></li><li><a href=#-关键知识点解释>🔍 关键知识点解释</a></li><li><a href=#-总结>🚀 总结</a></li></ul></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#-核心概念什么是字符设备>🌟 核心概念：什么是字符设备？</a></li><li><a href=#-第一关传统功夫--手动打造字符设备驱动>🏗️ 第一关：传统功夫 —— 手动打造字符设备驱动</a><ul><li><ul><li><a href=#-通俗讲解>🗣️ 通俗讲解</a></li></ul></li><li><a href=#-代码实践>💻 代码实践</a></li></ul></li><li><a href=#-第二关自动挂牌--创建设备节点>🚪 第二关：自动挂牌 —— 创建设备节点</a><ul><li><a href=#-通俗讲解-1>🗣️ 通俗讲解</a></li><li><a href=#-代码实践-1>💻 代码实践</a></li></ul></li><li><a href=#-第三关数据搬运--用户与内核的交互>📦 第三关：数据搬运 —— 用户与内核的交互</a><ul><li><a href=#-通俗讲解-2>🗣️ 通俗讲解</a></li><li><a href=#-代码实践-2>💻 代码实践</a></li></ul></li><li><a href=#-第四关极简模式--杂项设备驱动-misc-device>🚀 第四关：极简模式 —— 杂项设备驱动 (Misc Device)</a><ul><li><a href=#-通俗讲解-3>🗣️ 通俗讲解</a></li><li><a href=#-代码实践-3>💻 代码实践</a></li></ul></li><li><a href=#-第五关高手进阶--私有数据与一驱多用>🧩 第五关：高手进阶 —— 私有数据与一驱多用</a><ul><li><a href=#-通俗讲解-4>🗣️ 通俗讲解</a></li><li><a href=#-通俗讲解全局变量-vs-私有数据>🏨 通俗讲解：全局变量 vs 私有数据</a><ul><li><a href=#1-全局变量的做法错误示范>1. 全局变量的做法（错误示范）</a></li><li><a href=#2-私有数据的做法private_data>2. 私有数据的做法（private_data）</a></li></ul></li><li><a href=#-代码实战多-app-数据隔离实验>💻 代码实战：多 APP 数据隔离实验</a><ul><li><a href=#1-驱动代码-private_data_drvc>1. 驱动代码 (<code>private_data_drv.c</code>)</a></li><li><a href=#2-测试应用程序-app_testc>2. 测试应用程序 (<code>app_test.c</code>)</a></li><li><a href=#-实验步骤见证奇迹的时刻>🧪 实验步骤（见证奇迹的时刻）</a></li><li><a href=#-为什么会这样底层逻辑>🔍 为什么会这样？（底层逻辑）</a></li></ul></li></ul></li><li><a href=#新增官方文档私有数据处理方法>新增：官方文档私有数据处理方法</a><ul><li><a href=#做法>做法</a></li><li><a href=#why为什么不直接用全局变量-dev1>why（为什么不直接用全局变量 <code>dev1</code>？）</a></li><li><a href=#优点>优点</a></li><li><a href=#区别对比表>区别对比表</a></li><li><a href=#场景还原如果两个-app-同时打开设备>场景还原：如果两个 APP 同时打开设备</a></li></ul></li><li><a href=#第六关使用-goto-跳转到错误处理处>第六关：使用 goto 跳转到错误处理处</a><ul><li><a href=#-通俗比喻>🏰 通俗比喻</a><ul><li><a href=#-如果没有错误处理耍流氓>❌ 如果没有错误处理（耍流氓）</a></li><li><a href=#-正确的错误处理倒叙撤销>✅ 正确的错误处理（倒叙撤销）</a></li></ul></li><li><a href=#-为什么要用-goto>🛠️ 为什么要用 <code>goto</code>？</a></li><li><a href=#-代码实战带错误处理的驱动框架>💻 代码实战：带错误处理的驱动框架</a></li><li><a href=#-关键知识点解释>🔍 关键知识点解释</a></li><li><a href=#-总结>🚀 总结</a></li></ul></li></ul></nav></div></details><script>(function(){"use strict";const s=.33,o="#TableOfContents",i=".anchor",a='a[href^="#"]',r="li ul",c="active";let t=!1;function l(e,n){const o=window.scrollY+window.innerHeight*n,i=[...document.querySelectorAll('#TableOfContents a[href^="#"]')],s=new Set(i.map(e=>e.getAttribute("href").substring(1)));if(t)for(let t=0;t<e.length;t++){const n=e[t];if(!s.has(n.id))continue;const o=n.getBoundingClientRect().top+window.scrollY;if(Math.abs(window.scrollY-o)<100)return n.id}for(let t=e.length-1;t>=0;t--){const n=e[t].getBoundingClientRect().top+window.scrollY;if(n<=o&&s.has(e[t].id))return e[t].id}return e.find(e=>s.has(e.id))?.id||""}function e({toc:e,anchors:t,links:n,scrollOffset:s,collapseInactive:o}){const i=l(t,s);if(!i)return;if(n.forEach(e=>{const t=e.getAttribute("href")===`#${i}`;if(e.classList.toggle(c,t),o){const n=e.closest("li")?.querySelector("ul");n&&(n.style.display=t?"":"none")}}),o){const n=e.querySelector(`a[href="#${CSS.escape(i)}"]`);let t=n;for(;t&&t!==e;)t.tagName==="UL"&&(t.style.display=""),t.tagName==="LI"&&t.querySelector("ul")?.style.setProperty("display",""),t=t.parentElement}}function n(){const n=document.querySelector(o);if(!n)return;const l=!0,u=[...document.querySelectorAll(i)],d=[...n.querySelectorAll(a)];l&&n.querySelectorAll(r).forEach(e=>e.style.display="none"),d.forEach(e=>{e.addEventListener("click",()=>{t=!0})});const c={toc:n,anchors:u,links:d,scrollOffset:s,collapseInactive:l};window.addEventListener("scroll",()=>e(c),{passive:!0}),window.addEventListener("hashchange",()=>e(c),{passive:!0}),e(c)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n):n()})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h2 class="relative group">🌟 核心概念：什么是字符设备？<div id=-核心概念什么是字符设备 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5%e4%bb%80%e4%b9%88%e6%98%af%e5%ad%97%e7%ac%a6%e8%ae%be%e5%a4%87 aria-label=Anchor>#</a></span></h2><p>在 Linux 的世界里，<strong>一切皆文件</strong>。
字符设备（Character Device）就是<strong>像水流一样，按顺序一个字节一个字节传输数据的设备</strong>。</p><ul><li><strong>例子</strong>：键盘、鼠标、串口、LED 灯、蜂鸣器。</li><li><strong>目的</strong>：你的驱动程序要把硬件伪装成一个文件（例如 <code>/dev/my_led</code>），让应用程序可以通过 <code>open</code>、<code>read</code>、<code>write</code> 这些标准函数来控制硬件。</li></ul><hr><h2 class="relative group">🏗️ 第一关：传统功夫 —— 手动打造字符设备驱动<div id=-第一关传统功夫--手动打造字符设备驱动 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e7%ac%ac%e4%b8%80%e5%85%b3%e4%bc%a0%e7%bb%9f%e5%8a%9f%e5%a4%ab--%e6%89%8b%e5%8a%a8%e6%89%93%e9%80%a0%e5%ad%97%e7%ac%a6%e8%ae%be%e5%a4%87%e9%a9%b1%e5%8a%a8 aria-label=Anchor>#</a></span></h2><p><strong>(知识点：申请设备号、注册 cdev、cdev_add)</strong></p><h4 class="relative group">🗣️ 通俗讲解<div id=-通俗讲解 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e9%80%9a%e4%bf%97%e8%ae%b2%e8%a7%a3 aria-label=Anchor>#</a></span></h4><p>你要在 Linux 内核里开一家“店”（驱动），必须办两件事：</p><ol><li><p><strong>申请营业执照（设备号）</strong>：</p><ul><li><strong>主设备号</strong>：代表行业（比如“这是 LED 行业”）。</li><li><strong>次设备号</strong>：代表具体分店（比如“这是 LED 1 号店，那是 LED 2 号店”）。</li><li><em>静态申请设备号</em>：<code>register_chrdev_region</code>（申请前需要<code>MKDEV(major, minor)</code>传入主次设备号）。</li><li><em>动态申请设备号</em>：<code>alloc_chrdev_region</code>（让内核自动分配一个没被占用的号码，更安全）。</li></ul></li><li><p><strong>关联具体操作与营业执照</strong>：</p><ul><li>拿到执照后，你要告诉工商局(内核)，顾客来了能做什么。比如，可以“开门”(<code>open</code>)，“读取商品信息”(<code>read</code>)，“下单”(write)。这些操作的集合，就是一个 <code>file_operations</code> 结构体。我们需要把这个结构体和设备号关联起来，这个过程叫注册字符设备 (<code>cdev</code>)。</li></ul></li></ol><h3 class="relative group">💻 代码实践<div id=-代码实践 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e4%bb%a3%e7%a0%81%e5%ae%9e%e8%b7%b5 aria-label=Anchor>#</a></span></h3><p>这是一个最基础的驱动骨架，加载后内核里有了你的位置，但还没有文件节点。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/module.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/init.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/fs.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/cdev.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// 定义设备名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define DEV_NAME &#34;test_chrdev&#34;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// 全局变量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>dev_t</span> <span class=n>dev_num</span><span class=p>;</span>       <span class=c1>// 存放申请到的设备号(主+次)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=k>struct</span> <span class=n>cdev</span> <span class=n>my_cdev</span><span class=p>;</span> <span class=c1>// 字符设备核心结构体
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 1. 定义文件操作集 (店员的工作手册)
</span></span></span><span class=line><span class=cl><span class=c1>// 目前什么都不做，只是为了编译通过
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>int</span> <span class=nf>my_open</span><span class=p>(</span><span class=k>struct</span> <span class=n>inode</span> <span class=o>*</span><span class=n>inode</span><span class=p>,</span> <span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;迅为RK3568: 设备被打开了</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>file_operations</span> <span class=n>my_fops</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* 顾客来了能做什么,定义商店的经营方法 */</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>owner</span> <span class=o>=</span> <span class=n>THIS_MODULE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>open</span> <span class=o>=</span> <span class=n>my_open</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 2. 驱动入口 (开业)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>int</span> <span class=n>__init</span> <span class=nf>my_driver_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// A. 动态申请设备号
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 参数: 存放结果的指针, 次设备号起始(0), 申请数量(1), 名字
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>alloc_chrdev_region</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dev_num</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>DEV_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;申请设备号失败</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;申请成功: 主设备号=%d, 次设备号=%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>MAJOR</span><span class=p>(</span><span class=n>dev_num</span><span class=p>),</span> <span class=nf>MINOR</span><span class=p>(</span><span class=n>dev_num</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// B. 初始化cdev (绑定我们要用的操作函数集)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>cdev_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_cdev</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>my_fops</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// C. 添加cdev到内核 (正式注册)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>cdev_add</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_cdev</span><span class=p>,</span> <span class=n>dev_num</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;注册cdev失败</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>unregister_chrdev_region</span><span class=p>(</span><span class=n>dev_num</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span> <span class=c1>// 失败了记得退还设备号
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;字符设备注册完成！</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 3. 驱动出口 (关门)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>void</span> <span class=n>__exit</span> <span class=nf>my_driver_exit</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// A. 删除cdev
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>cdev_del</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_cdev</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// B. 归还设备号
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>unregister_chrdev_region</span><span class=p>(</span><span class=n>dev_num</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;字符设备已卸载</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>module_init</span><span class=p>(</span><span class=n>my_driver_init</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>module_exit</span><span class=p>(</span><span class=n>my_driver_exit</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>MODULE_LICENSE</span><span class=p>(</span><span class=s>&#34;GPL&#34;</span><span class=p>);</span>
</span></span></code></pre></div><hr><h2 class="relative group">🚪 第二关：自动挂牌 —— 创建设备节点<div id=-第二关自动挂牌--创建设备节点 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e7%ac%ac%e4%ba%8c%e5%85%b3%e8%87%aa%e5%8a%a8%e6%8c%82%e7%89%8c--%e5%88%9b%e5%bb%ba%e8%ae%be%e5%a4%87%e8%8a%82%e7%82%b9 aria-label=Anchor>#</a></span></h2><p><strong>(知识点：class_create, device_create)</strong></p><h3 class="relative group">🗣️ 通俗讲解<div id=-通俗讲解-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e9%80%9a%e4%bf%97%e8%ae%b2%e8%a7%a3-1 aria-label=Anchor>#</a></span></h3><p>在第一关，你的店注册了，但是在街道上（<code>/dev/</code> 目录）没有门牌，用户找不到你。这个门牌就是<code> /dev</code> 目录下的一个文件，比如<code> /dev/mydevice</code>.我们希望加载驱动时，这个文件能自动出现；卸载时，自动消失。</p><ol><li><strong>创建类 (<code>class_create</code>)</strong>：在 <code>/sys/class</code> 下建个分类目录。 相当于创建一条商业街</li><li><strong>创建设备 (<code>device_create</code>)</strong>：在分类下建个设备信息，系统会自动在 <code>/dev</code> 下生成对应的文件。在商业街上创建我们的“店面”，并取名</li></ol><h3 class="relative group">💻 代码实践<div id=-代码实践-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e4%bb%a3%e7%a0%81%e5%ae%9e%e8%b7%b5-1 aria-label=Anchor>#</a></span></h3><p>在第一关的基础上，增加自动创建节点的代码。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// ... (保留上面的头文件和变量)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#include</span> <span class=cpf>&lt;linux/device.h&gt; // 新增头文件</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>class</span> <span class=o>*</span><span class=n>my_class</span><span class=p>;</span>   <span class=c1>// 类
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=k>struct</span> <span class=n>device</span> <span class=o>*</span><span class=n>my_device</span><span class=p>;</span> <span class=c1>// 设备
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>__init</span> <span class=nf>my_driver_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ... (alloc_chrdev_region 和 cdev_add 代码同上，省略) ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 1. 创建类 (会在 /sys/class/ 下生成 my_class_test 目录)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 创建一条“商业街”
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>my_class</span> <span class=o>=</span> <span class=nf>class_create</span><span class=p>(</span><span class=n>THIS_MODULE</span><span class=p>,</span> <span class=s>&#34;my_class_test&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>IS_ERR</span><span class=p>(</span><span class=n>my_class</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nf>PTR_ERR</span><span class=p>(</span><span class=n>my_class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 2. 创建设备节点 (会在 /dev/ 下生成 my_device_node 文件)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 在商业街上创建我们的“店面”，并取名 &#34;my_device_node&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 参数: 类, 父设备(NULL), 设备号, 私有数据(NULL), 设备名
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>my_device</span> <span class=o>=</span> <span class=nf>device_create</span><span class=p>(</span><span class=n>my_class</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=n>dev_num</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=s>&#34;my_device_node&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>IS_ERR</span><span class=p>(</span><span class=n>my_device</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>class_destroy</span><span class=p>(</span><span class=n>my_class</span><span class=p>);</span> <span class=c1>// 失败了要回滚
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nf>PTR_ERR</span><span class=p>(</span><span class=n>my_device</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;设备节点 /dev/my_device_node 已自动生成</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=n>__exit</span> <span class=nf>my_driver_exit</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// --- 新增步骤 3.销毁设备节点 (注意顺序：先销毁设备，再销毁类) ---
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>device_destroy</span><span class=p>(</span><span class=n>my_class</span><span class=p>,</span> <span class=n>dev_num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>class_destroy</span><span class=p>(</span><span class=n>my_class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 2.注销字符设备
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>cdev_del</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_cdev</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 1.归还设备号
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>unregister_chrdev_region</span><span class=p>(</span><span class=n>dev</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=n>KERN_INFO</span> <span class=s>&#34;----------------MyDevice: 店铺已摘牌，打烊了！</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>验证</strong>：加载驱动后，直接 <code>ls /dev/my_device_node</code>，你会发现文件已经存在了。</p><hr><h2 class="relative group">📦 第三关：数据搬运 —— 用户与内核的交互<div id=-第三关数据搬运--用户与内核的交互 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e7%ac%ac%e4%b8%89%e5%85%b3%e6%95%b0%e6%8d%ae%e6%90%ac%e8%bf%90--%e7%94%a8%e6%88%b7%e4%b8%8e%e5%86%85%e6%a0%b8%e7%9a%84%e4%ba%a4%e4%ba%92 aria-label=Anchor>#</a></span></h2><p><strong>(知识点：copy_to_user, copy_from_user)</strong></p><h3 class="relative group">🗣️ 通俗讲解<div id=-通俗讲解-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e9%80%9a%e4%bf%97%e8%ae%b2%e8%a7%a3-2 aria-label=Anchor>#</a></span></h3><p>Linux 为了安全，把内存划分为<strong>用户空间</strong>（APP）和<strong>内核空间</strong>（驱动）。它们之间有一堵墙，不能直接互传指针。</p><ul><li><strong>APP 写数据给驱动 (<code>write</code>)</strong>：驱动必须用 <code>copy_from_user</code> 把数据从墙外拉进来。顾客（用户）把东西给仓库（内核）</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl> <span class=nf>copy_from_user</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>to</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=n>__user</span> <span class=o>*</span><span class=n>from</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// to: 给谁？从用户空间拿来数据要给谁？当然是内核空间了。 kbuf(仓库自己的箱子)：目的地。
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// from:从哪里来？当然是从用户空间来了。 buf (顾客手里的箱子)：源头。用户空间的数据地址。
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// size (数量)：要拿多少个苹果。
</span></span></span></code></pre></div><ul><li><p><strong>驱动发数据给 APP (<code>read</code>)</strong>：驱动必须用 <code>copy_to_user</code> 把数据扔到墙外去。仓库（内核）把东西给顾客（用户）。</p></li><li><p><code>copy_from_user</code> 和 <code>copy_to_user</code> 是对驱动而言；<code>read</code> 和 <code>write</code> 是对用户而言</p></li></ul><h3 class="relative group">💻 代码实践<div id=-代码实践-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e4%bb%a3%e7%a0%81%e5%ae%9e%e8%b7%b5-2 aria-label=Anchor>#</a></span></h3><p>实现一个简单的读写回显功能。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/uaccess.h&gt; // 必须包含这个头文件</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>char</span> <span class=n>kbuf</span><span class=p>[</span><span class=mi>128</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span> <span class=c1>// 内核里的缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 读函数：APP读取时调用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>ssize_t</span> <span class=nf>my_read</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>size</span><span class=p>,</span> <span class=kt>loff_t</span> <span class=o>*</span><span class=n>ppos</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// copy_to_user(用户地址, 内核地址, 长度)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 返回值：没拷贝成功的字节数，0表示全成功
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>ret</span> <span class=o>=</span> <span class=nf>copy_to_user</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>kbuf</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=n>EFAULT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;APP读走了数据: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>kbuf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 写函数：APP写入时调用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>ssize_t</span> <span class=nf>my_write</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>size</span><span class=p>,</span> <span class=kt>loff_t</span> <span class=o>*</span><span class=n>ppos</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// copy_from_user(内核地址, 用户地址, 长度)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>ret</span> <span class=o>=</span> <span class=nf>copy_from_user</span><span class=p>(</span><span class=n>kbuf</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=n>EFAULT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;APP写入了数据: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>kbuf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 记得把这两个函数填入 file_operations 结构体
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=k>struct</span> <span class=n>file_operations</span> <span class=n>my_fops</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>owner</span> <span class=o>=</span> <span class=n>THIS_MODULE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>open</span> <span class=o>=</span> <span class=n>my_open</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>read</span> <span class=o>=</span> <span class=n>my_read</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>write</span> <span class=o>=</span> <span class=n>my_write</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><hr><h2 class="relative group">🚀 第四关：极简模式 —— 杂项设备驱动 (Misc Device)<div id=-第四关极简模式--杂项设备驱动-misc-device class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e7%ac%ac%e5%9b%9b%e5%85%b3%e6%9e%81%e7%ae%80%e6%a8%a1%e5%bc%8f--%e6%9d%82%e9%a1%b9%e8%ae%be%e5%a4%87%e9%a9%b1%e5%8a%a8-misc-device aria-label=Anchor>#</a></span></h2><p><strong>(知识点：misc_register)</strong></p><h3 class="relative group">🗣️ 通俗讲解<div id=-通俗讲解-3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e9%80%9a%e4%bf%97%e8%ae%b2%e8%a7%a3-3 aria-label=Anchor>#</a></span></h3><p>如果你觉得上面的 <code>alloc_chrdev</code> -> <code>cdev</code> -> <code>class</code> -> <code>device</code> 这一套流程太繁琐了，Linux 提供了一个<strong>懒人包</strong>：<strong>杂项设备 (Misc Device)</strong>。</p><ul><li>它自动固定主设备号为 <strong>10</strong>。</li><li>它自动帮你申请次设备号。</li><li>它自动帮你创建 <code>/dev/</code> 下的节点。</li><li><strong>非常适合</strong>：简单的字符设备（蜂鸣器、看门狗、ADC 等）。</li></ul><h3 class="relative group">💻 代码实践<div id=-代码实践-3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e4%bb%a3%e7%a0%81%e5%ae%9e%e8%b7%b5-3 aria-label=Anchor>#</a></span></h3><p>你会发现代码量瞬间减少。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/module.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/init.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/miscdevice.h&gt; // 核心头文件</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/fs.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// 定义操作函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>int</span> <span class=nf>my_misc_open</span><span class=p>(</span><span class=k>struct</span> <span class=n>inode</span> <span class=o>*</span><span class=n>inode</span><span class=p>,</span> <span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;Misc设备被打开</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>file_operations</span> <span class=n>misc_fops</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>owner</span> <span class=o>=</span> <span class=n>THIS_MODULE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>open</span> <span class=o>=</span> <span class=n>my_misc_open</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 定义杂项设备结构体
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=k>struct</span> <span class=n>miscdevice</span> <span class=n>my_misc_dev</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>minor</span> <span class=o>=</span> <span class=n>MISC_DYNAMIC_MINOR</span><span class=p>,</span> <span class=c1>// 自动分配次设备号
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=s>&#34;my_misc_test&#34;</span><span class=p>,</span>      <span class=c1>// 自动生成 /dev/my_misc_test
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>fops</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>misc_fops</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>__init</span> <span class=nf>my_misc_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 一步注册！
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>ret</span> <span class=o>=</span> <span class=nf>misc_register</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_misc_dev</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;Misc注册失败</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;Misc驱动注册成功</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=n>__exit</span> <span class=nf>my_misc_exit</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 一步卸载
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>misc_deregister</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_misc_dev</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;Misc驱动卸载</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>module_init</span><span class=p>(</span><span class=n>my_misc_init</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>module_exit</span><span class=p>(</span><span class=n>my_misc_exit</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>MODULE_LICENSE</span><span class=p>(</span><span class=s>&#34;GPL&#34;</span><span class=p>);</span>
</span></span></code></pre></div><hr><h2 class="relative group">🧩 第五关：高手进阶 —— 私有数据与一驱多用<div id=-第五关高手进阶--私有数据与一驱多用 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e7%ac%ac%e4%ba%94%e5%85%b3%e9%ab%98%e6%89%8b%e8%bf%9b%e9%98%b6--%e7%a7%81%e6%9c%89%e6%95%b0%e6%8d%ae%e4%b8%8e%e4%b8%80%e9%a9%b1%e5%a4%9a%e7%94%a8 aria-label=Anchor>#</a></span></h2><p><strong>(知识点：private_data, container_of, 面向对象的思想)</strong></p><h3 class="relative group">🗣️ 通俗讲解<div id=-通俗讲解-4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e9%80%9a%e4%bf%97%e8%ae%b2%e8%a7%a3-4 aria-label=Anchor>#</a></span></h3><p>这是从入门到进阶最关键的一步。
<strong>问题</strong>：如果 RK3568 板子上有 3 个 LED 灯，难道我要写 3 个驱动（led1_drv, led2_drv&mldr;）吗？
<strong>答案</strong>：当然不！我们要写<strong>1 个驱动</strong>，管理<strong>3 个设备</strong>。</p><p><strong>怎么做？</strong></p><ol><li><strong>定义一个结构体</strong>：把每个 LED 的属性（比如 GPIO 号、名字）包起来。</li><li><strong>使用 <code>private_data</code></strong>：当 APP 打开 <code>/dev/led1</code> 时，驱动在 <code>open</code> 函数里识别出是“1 号灯”，然后把 1 号灯的结构体指针存入 <code>file->private_data</code> 这个“背包”里。</li><li><strong>读写时</strong>：在 <code>write</code> 函数里，从“背包”里拿出数据，就知道现在操作的是哪个灯，而不会乱套。</li></ol><p>没问题！这一关确实是 Linux 驱动开发中<strong>从新手到老手</strong>的分水岭。如果只用全局变量，那叫“裸机思维”；学会用 <code>private_data</code>，才算真正有了“Linux 驱动思维”。</p><p>我们换一个更直观的场景：<strong>住酒店</strong>。</p><hr><h3 class="relative group">🏨 通俗讲解：全局变量 vs 私有数据<div id=-通俗讲解全局变量-vs-私有数据 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e9%80%9a%e4%bf%97%e8%ae%b2%e8%a7%a3%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f-vs-%e7%a7%81%e6%9c%89%e6%95%b0%e6%8d%ae aria-label=Anchor>#</a></span></h3><p>假设你开了一家酒店（驱动程序），有一个房间（内存缓冲区）。</p><h4 class="relative group">1. 全局变量的做法（错误示范）<div id=1-全局变量的做法错误示范 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#1-%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f%e7%9a%84%e5%81%9a%e6%b3%95%e9%94%99%e8%af%af%e7%a4%ba%e8%8c%83 aria-label=Anchor>#</a></span></h4><p>你酒店里<strong>只有一个</strong>公共储物柜（全局变量 <code>static char kbuf[128]</code>）。</p><ul><li><strong>客人 A（APP 1）</strong> 入住，把他的 <strong>钱包</strong> 放进了柜子。</li><li><strong>客人 B（APP 2）</strong> 入住，把他的 <strong>臭袜子</strong> 放进了同一个柜子（覆盖了钱包）。</li><li><strong>客人 A</strong> 想要取回东西，结果拿出了一双 <strong>臭袜子</strong>。</li><li><strong>后果</strong>：客人打起来了，数据乱套了。</li></ul><h4 class="relative group">2. 私有数据的做法（private_data）<div id=2-私有数据的做法private_data class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#2-%e7%a7%81%e6%9c%89%e6%95%b0%e6%8d%ae%e7%9a%84%e5%81%9a%e6%b3%95private_data aria-label=Anchor>#</a></span></h4><p>Linux 内核设计了一套机制：</p><ul><li><strong>Open (办理入住)</strong>：当前台（<code>open</code>函数）接到客人时，立马给客人分配一个<strong>专属房间</strong>（<code>kmalloc</code> 申请一块内存），并把<strong>房卡</strong>（内存地址）挂在客人的档案（<code>file</code>结构体）上的 <code>private_data</code> 字段里。</li><li><strong>Write/Read (回房间办事)</strong>：客人要存取东西时，必须出示档案。驱动通过 <code>file->private_data</code> 拿到房卡，找到<strong>只属于这个客人的房间</strong>进行操作。</li><li><strong>Release (退房)</strong>：客人走的时候，驱动回收房卡，并打扫房间（<code>kfree</code> 释放内存）。</li></ul><p><strong>结论</strong>：不管有多少个客人同时入住，每个人都只在自己的房间里折腾，互不干扰。</p><hr><h3 class="relative group">💻 代码实战：多 APP 数据隔离实验<div id=-代码实战多-app-数据隔离实验 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e4%bb%a3%e7%a0%81%e5%ae%9e%e6%88%98%e5%a4%9a-app-%e6%95%b0%e6%8d%ae%e9%9a%94%e7%a6%bb%e5%ae%9e%e9%aa%8c aria-label=Anchor>#</a></span></h3><p>这个驱动实现了：<strong>APP 1 写入的数据，只有 APP 1 能读到；APP 2 写入的数据，只有 APP 2 能读到。</strong> 即使它们打开的是同一个设备文件 <code>/dev/test_private</code>。</p><h4 class="relative group">1. 驱动代码 (<code>private_data_drv.c</code>)<div id=1-驱动代码-private_data_drvc class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#1-%e9%a9%b1%e5%8a%a8%e4%bb%a3%e7%a0%81-private_data_drvc aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/init.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/module.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/fs.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/cdev.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/device.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/uaccess.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/slab.h&gt; // 必须包含！为了使用 kmalloc 和 kfree</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// 定义设备名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define DEV_NAME &#34;test_private&#34;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// 核心：定义一个结构体，代表“一个客人的专属房间”
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>session_data</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buffer</span><span class=p>[</span><span class=mi>128</span><span class=p>];</span> <span class=c1>// 客人的私有储物柜
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 全局变量只用来管“执照”和“门牌”，不管具体数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>dev_t</span> <span class=n>dev_num</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>cdev</span> <span class=n>my_cdev</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>class</span> <span class=o>*</span><span class=n>my_class</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>device</span> <span class=o>*</span><span class=n>my_device</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// --- 1. 打开设备 (办理入住) ---
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>int</span> <span class=nf>my_open</span><span class=p>(</span><span class=k>struct</span> <span class=n>inode</span> <span class=o>*</span><span class=n>inode</span><span class=p>,</span> <span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// A. 为当前这个“客人”申请一块独立的内存 (开一间新房)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// GFP_KERNEL 表示正常的内核内存分配
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>struct</span> <span class=n>session_data</span> <span class=o>*</span><span class=n>new_data</span> <span class=o>=</span> <span class=nf>kmalloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>session_data</span><span class=p>),</span> <span class=n>GFP_KERNEL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>new_data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=n>ENOMEM</span><span class=p>;</span> <span class=c1>// 内存不足，入住失败
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// B. 初始化一下内存，清零
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>memset</span><span class=p>(</span><span class=n>new_data</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>session_data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// C. 关键！！把房间钥匙(地址)挂在 file-&gt;private_data 上
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 以后这个 file 指针不管传给 read 还是 write，我们都能找回这块内存
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>file</span><span class=o>-&gt;</span><span class=n>private_data</span> <span class=o>=</span> <span class=n>new_data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;驱动日志: 这里的 open 被调用了，已分配私有内存地址: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>new_data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// --- 2. 写入数据 (存东西) ---
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>ssize_t</span> <span class=nf>my_write</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>size</span><span class=p>,</span> <span class=kt>loff_t</span> <span class=o>*</span><span class=n>ppos</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// A. 关键！！从 private_data 里拿出当事人的专属内存指针
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>struct</span> <span class=n>session_data</span> <span class=o>*</span><span class=n>data</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>session_data</span> <span class=o>*</span><span class=p>)</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>private_data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 防止溢出
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>size</span> <span class=o>&gt;</span> <span class=mi>128</span><span class=p>)</span> <span class=n>size</span> <span class=o>=</span> <span class=mi>128</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// B. 把数据写入到“他的”buffer里，而不是全局变量里
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>copy_from_user</span><span class=p>(</span><span class=n>data</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ret</span><span class=p>)</span> <span class=k>return</span> <span class=o>-</span><span class=n>EFAULT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;驱动日志: 写入数据到私有内存(%p): %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>data</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// --- 3. 读取数据 (取东西) ---
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>ssize_t</span> <span class=nf>my_read</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=kt>char</span> <span class=n>__user</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>size</span><span class=p>,</span> <span class=kt>loff_t</span> <span class=o>*</span><span class=n>ppos</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// A. 关键！！拿出当事人的指针
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>struct</span> <span class=n>session_data</span> <span class=o>*</span><span class=n>data</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>session_data</span> <span class=o>*</span><span class=p>)</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>private_data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// B. 从“他的”buffer里读数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>copy_to_user</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>data</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ret</span><span class=p>)</span> <span class=k>return</span> <span class=o>-</span><span class=n>EFAULT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;驱动日志: 从私有内存(%p)读取数据: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>data</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// --- 4. 关闭设备 (退房) ---
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>int</span> <span class=nf>my_release</span><span class=p>(</span><span class=k>struct</span> <span class=n>inode</span> <span class=o>*</span><span class=n>inode</span><span class=p>,</span> <span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// A. 取出指针
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>struct</span> <span class=n>session_data</span> <span class=o>*</span><span class=n>data</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>session_data</span> <span class=o>*</span><span class=p>)</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>private_data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// B. 释放内存 (一定要做！否则这块内存就丢了，这叫内存泄漏)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;驱动日志: 释放私有内存地址: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>kfree</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 操作函数集
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=k>struct</span> <span class=n>file_operations</span> <span class=n>my_fops</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>owner</span> <span class=o>=</span> <span class=n>THIS_MODULE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>open</span> <span class=o>=</span> <span class=n>my_open</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>read</span> <span class=o>=</span> <span class=n>my_read</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>write</span> <span class=o>=</span> <span class=n>my_write</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>release</span> <span class=o>=</span> <span class=n>my_release</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 驱动入口
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>int</span> <span class=n>__init</span> <span class=nf>my_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 动态申请设备号
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>alloc_chrdev_region</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dev_num</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>DEV_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 初始化cdev
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>cdev_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_cdev</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>my_fops</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>cdev_add</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_cdev</span><span class=p>,</span> <span class=n>dev_num</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 自动创建节点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>my_class</span> <span class=o>=</span> <span class=nf>class_create</span><span class=p>(</span><span class=n>THIS_MODULE</span><span class=p>,</span> <span class=s>&#34;private_class&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>my_device</span> <span class=o>=</span> <span class=nf>device_create</span><span class=p>(</span><span class=n>my_class</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=n>dev_num</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=n>DEV_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;驱动日志: 驱动加载成功，设备节点 /dev/%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>DEV_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 驱动出口
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>void</span> <span class=n>__exit</span> <span class=nf>my_exit</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>device_destroy</span><span class=p>(</span><span class=n>my_class</span><span class=p>,</span> <span class=n>dev_num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>class_destroy</span><span class=p>(</span><span class=n>my_class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>cdev_del</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_cdev</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>unregister_chrdev_region</span><span class=p>(</span><span class=n>dev_num</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;驱动日志: 驱动卸载成功</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>module_init</span><span class=p>(</span><span class=n>my_init</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>module_exit</span><span class=p>(</span><span class=n>my_exit</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>MODULE_LICENSE</span><span class=p>(</span><span class=s>&#34;GPL&#34;</span><span class=p>);</span>
</span></span></code></pre></div><hr><h4 class="relative group">2. 测试应用程序 (<code>app_test.c</code>)<div id=2-测试应用程序-app_testc class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#2-%e6%b5%8b%e8%af%95%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f-app_testc aria-label=Anchor>#</a></span></h4><p>为了验证效果，我们可以运行两个这个程序的实例。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;用法: ./app &lt;要写入的字符串&gt;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;/dev/test_private&#34;</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;打开失败&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>write_buf</span><span class=p>[</span><span class=mi>128</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>read_buf</span><span class=p>[</span><span class=mi>128</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 1. 写入用户传入的字符串
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>strncpy</span><span class=p>(</span><span class=n>write_buf</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>128</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[APP] 正在写入: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>write_buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>write</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>write_buf</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>write_buf</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 2. 模拟一段长时间的等待，为了让我们有时间去运行另一个APP
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[APP] 写入完成。现在睡眠10秒...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[APP] 请赶紧去另一个终端运行 ./app &lt;其他字符串&gt; 来测试干扰！</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>sleep</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 3. 醒来后读取数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[APP] 醒来了，准备读取...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>read_buf</span><span class=p>,</span> <span class=mi>128</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[APP] 读取到的内容: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>read_buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 4. 验证
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>strcmp</span><span class=p>(</span><span class=n>write_buf</span><span class=p>,</span> <span class=n>read_buf</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[APP] 测试成功！数据没被别人覆盖。</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[APP] 测试失败！数据被别人篡改了！</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><h4 class="relative group">🧪 实验步骤（见证奇迹的时刻）<div id=-实验步骤见证奇迹的时刻 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e5%ae%9e%e9%aa%8c%e6%ad%a5%e9%aa%a4%e8%a7%81%e8%af%81%e5%a5%87%e8%bf%b9%e7%9a%84%e6%97%b6%e5%88%bb aria-label=Anchor>#</a></span></h4><p>请在板子上打开 <strong>两个</strong> 终端窗口。</p><ol><li><p><strong>加载驱动</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>insmod private_data_drv.ko
</span></span></code></pre></div></li><li><p><strong>在 终端 A 运行 APP（写入 &ldquo;AAAAA&rdquo;）</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./app AAAAA
</span></span></code></pre></div><p><em>它会提示你：“写入完成，睡眠 10 秒&mldr;”</em></p></li><li><p><strong>迅速在 终端 B 运行 APP（写入 &ldquo;BBBBB&rdquo;）</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./app BBBBB
</span></span></code></pre></div><p><em>它也会写入并睡眠。</em></p></li><li><p><strong>观察结果</strong>：</p><ul><li>如果用的是 <strong>全局变量</strong>：<ul><li>终端 A 醒来后，读到的会是 &ldquo;BBBBB&rdquo;（因为被后来者覆盖了）。</li></ul></li><li>如果用的是 <strong>private_data</strong>（上面的代码）：<ul><li>终端 A 醒来，读到的一定是 <strong>&ldquo;AAAAA&rdquo;</strong>。</li><li>终端 B 醒来，读到的一定是 <strong>&ldquo;BBBBB&rdquo;</strong>。</li></ul></li></ul></li></ol><h4 class="relative group">🔍 为什么会这样？（底层逻辑）<div id=-为什么会这样底层逻辑 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e4%b8%ba%e4%bb%80%e4%b9%88%e4%bc%9a%e8%bf%99%e6%a0%b7%e5%ba%95%e5%b1%82%e9%80%bb%e8%be%91 aria-label=Anchor>#</a></span></h4><ol><li>终端 A 运行 <code>./app</code> -> 调用 <code>open</code> -> 驱动 <code>kmalloc</code> 了一块内存（假设地址 <code>0x1000</code>），挂在 A 的 <code>file->private_data</code> 上。</li><li>终端 B 运行 <code>./app</code> -> 调用 <code>open</code> -> 驱动 <strong>又</strong> <code>kmalloc</code> 了一块新内存（假设地址 <code>0x2000</code>），挂在 B 的 <code>file->private_data</code> 上。</li><li>A 写数据，写到了 <code>0x1000</code>。</li><li>B 写数据，写到了 <code>0x2000</code>。</li><li>A 读数据，驱动从 A 的 <code>file</code> 里取出 <code>0x1000</code>，读出 &ldquo;AAAAA&rdquo;。</li></ol><p>这就实现了完美的<strong>数据隔离</strong>。这就是 Linux 驱动支持多用户并发访问的基础！</p><hr><h2 class="relative group">新增：官方文档私有数据处理方法<div id=新增官方文档私有数据处理方法 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e6%96%b0%e5%a2%9e%e5%ae%98%e6%96%b9%e6%96%87%e6%a1%a3%e7%a7%81%e6%9c%89%e6%95%b0%e6%8d%ae%e5%a4%84%e7%90%86%e6%96%b9%e6%b3%95 aria-label=Anchor>#</a></span></h2><p><strong>（知识点：把全局变量打包，并通过指针传递）</strong>
<code>struct device_test dev1</code>定义在函数外面，是全局变量。编译的时候内存就分配好了，一直在那儿。</p><h3 class="relative group">做法<div id=做法 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e5%81%9a%e6%b3%95 aria-label=Anchor>#</a></span></h3><ol><li><strong>打包</strong>：他不再零散地定义 <code>dev_t dev_num</code>、<code>struct cdev</code>、<code>char kbuf[]</code>，而是定义了一个大结构体 <code>struct device_test</code>，把所有跟这个设备有关的东西都塞进去。并且定义了一个<strong>全局变量</strong> <code>struct device_test dev1;</code>。</li><li><strong>挂接</strong>：在 <code>open</code> 函数里，他执行了 <code>file->private_data = &amp;dev1;</code>。意思是：把这个<strong>全局变量的地址</strong>挂在这个文件指针上。</li><li><strong>使用</strong>：在 <code>write</code> 函数里，他不再直接使用全局变量名 <code>dev1.kbuf</code>，而是先取出指针 <code>test_dev = file->private_data</code>，再用 <code>test_dev->kbuf</code> 来操作。</li></ol><h3 class="relative group">why（为什么不直接用全局变量 <code>dev1</code>？）<div id=why为什么不直接用全局变量-dev1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#why%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%8d%e7%9b%b4%e6%8e%a5%e7%94%a8%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f-dev1 aria-label=Anchor>#</a></span></h3><p>虽然在这个特定的简单例子里，直接用 <code>dev1.kbuf</code> 和用 <code>private_data</code> 效果一模一样，但他的目的是<strong>为了规范化（面向对象思维）</strong>。</p><h3 class="relative group">优点<div id=优点 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e4%bc%98%e7%82%b9 aria-label=Anchor>#</a></span></h3><p>如果将来你的板子上有 2 个完全一样的设备（比如 dev1 和 dev2）。</p><ul><li>如果不使用 <code>private_data</code>：你需要写两套 write 函数（<code>write_for_dev1</code> 和 <code>write_for_dev2</code>），或者在函数里写大量的 <code>if/else</code>。</li><li>如果使用 <code>private_data</code>：你的 <code>write</code> 函数<strong>一行都不用改</strong>！<ul><li>打开 dev1 时，<code>private_data</code> 指向 <code>&amp;dev1</code>。</li><li>打开 dev2 时，<code>private_data</code> 指向 <code>&amp;dev2</code>。</li><li><code>write</code> 函数只管操作指针，不管具体指向谁。</li></ul></li></ul><p><strong>总结官方代码：</strong> 它是<strong>静态</strong>的用法。它主要解决的是**“驱动代码通用性”**的问题，让一套操作函数能服务于特定的硬件对象。</p><h3 class="relative group">区别对比表<div id=区别对比表 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e5%8c%ba%e5%88%ab%e5%af%b9%e6%af%94%e8%a1%a8 aria-label=Anchor>#</a></span></h3><table><thead><tr><th style=text-align:left>特性</th><th style=text-align:left>官方代码 (全局变量 &amp;dev1)</th><th style=text-align:left>第五关 (kmalloc)</th></tr></thead><tbody><tr><td style=text-align:left><strong>内存来源</strong></td><td style=text-align:left>全局静态区 (编译时决定)</td><td style=text-align:left>堆区 (运行时动态申请)</td></tr><tr><td style=text-align:left><strong>多 App 打开</strong></td><td style=text-align:left><strong>共享同一个空间</strong></td><td style=text-align:left><strong>数据完全隔离</strong></td></tr><tr><td style=text-align:left><strong>比喻</strong></td><td style=text-align:left>公园的长椅 (大家坐同一把椅子)</td><td style=text-align:left>酒店的房间 (每人开一间房)</td></tr><tr><td style=text-align:left><strong>适用场景</strong></td><td style=text-align:left><strong>硬件控制</strong> (比如 LED、GPIO)</td><td style=text-align:left><strong>软件缓冲区</strong> (比如虚拟串口、独立存储)</td></tr></tbody></table><h3 class="relative group">场景还原：如果两个 APP 同时打开设备<div id=场景还原如果两个-app-同时打开设备 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e5%9c%ba%e6%99%af%e8%bf%98%e5%8e%9f%e5%a6%82%e6%9e%9c%e4%b8%a4%e4%b8%aa-app-%e5%90%8c%e6%97%b6%e6%89%93%e5%bc%80%e8%ae%be%e5%a4%87 aria-label=Anchor>#</a></span></h3><ul><li><p><strong>官方代码的情况</strong>：</p><ul><li>APP A 打开设备 -> <code>private_data</code> 指向 <code>&amp;dev1</code>。</li><li>APP B 打开设备 -> <code>private_data</code> 指向 <code>&amp;dev1</code>。</li><li><strong>结果</strong>：A 和 B 操作的是<strong>同一块内存</strong>。A 写进去的数据，B 能读到；B 写进去的数据，也会覆盖 A 的数据。</li><li><strong>为什么这样设计？</strong> 因为对于<strong>硬件</strong>来说，物理上只有一个。比如板子上只有一个 LED 灯，无论 A 还是 B 来控制，控制的都是同一个物理寄存器。所以这里的 <code>dev1</code> 代表的是那个<strong>唯一的物理实体</strong>。</li></ul></li><li><p><strong>第五关代码 (<code>kmalloc</code>) 的情况</strong>：</p><ul><li>APP A 打开设备 -> <code>kmalloc</code> 申请了内存块 A -> <code>private_data</code> 指向 A。</li><li>APP B 打开设备 -> <code>kmalloc</code> 申请了内存块 B -> <code>private_data</code> 指向 B。</li><li><strong>结果</strong>：A 和 B 操作的是<strong>不同的内存</strong>。互不干扰。</li><li><strong>为什么这样设计？</strong> 这种通常用于<strong>纯软件驱动</strong>或者需要<strong>每个用户独立上下文</strong>的场景（比如每个连接都要有独立的接收缓冲区）。</li></ul></li></ul><hr><h2 class="relative group">第六关：使用 goto 跳转到错误处理处<div id=第六关使用-goto-跳转到错误处理处 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e7%ac%ac%e5%85%ad%e5%85%b3%e4%bd%bf%e7%94%a8-goto-%e8%b7%b3%e8%bd%ac%e5%88%b0%e9%94%99%e8%af%af%e5%a4%84%e7%90%86%e5%a4%84 aria-label=Anchor>#</a></span></h2><p>你好！这一节的内容非常实战，也是区分“写着玩”和“工业级代码”的重要标准。</p><p>在 Linux 内核里，资源（内存、设备号、节点等）是非常宝贵的。如果你的驱动加载到一半失败了，却不把之前申请的资源还回去，就会造成<strong>资源泄漏</strong>（Resource Leak）。久而久之，系统就会因为资源耗尽而崩溃。</p><hr><h3 class="relative group">🏰 通俗比喻<div id=-通俗比喻 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e9%80%9a%e4%bf%97%e6%af%94%e5%96%bb aria-label=Anchor>#</a></span></h3><p>假设你的驱动程序初始化（<code>init</code>）就像勇者要去城堡见国王，必须连过三道关卡：</p><ol><li><strong>第一关</strong>：申请设备号（拿通行证）。</li><li><strong>第二关</strong>：注册 cdev（登记身份）。</li><li><strong>第三关</strong>：创建设备节点（进入大殿）。</li></ol><h4 class="relative group">❌ 如果没有错误处理（耍流氓）<div id=-如果没有错误处理耍流氓 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e5%a6%82%e6%9e%9c%e6%b2%a1%e6%9c%89%e9%94%99%e8%af%af%e5%a4%84%e7%90%86%e8%80%8d%e6%b5%81%e6%b0%93 aria-label=Anchor>#</a></span></h4><ul><li>你过了第一关（拿到通行证）。</li><li>你过了第二关（登记了身份）。</li><li><strong>第三关失败了</strong>（大殿门锁坏了，进不去）。</li><li><strong>结果</strong>：你直接转身回家了。</li><li><strong>后果</strong>：由于你没退还通行证，也没注销身份，城堡名册里一直有你，但实际上你人不在。下次再来申请，管理员说：“你不是已经在里面了吗？”——<strong>这就是资源泄漏/冲突。</strong></li></ul><h4 class="relative group">✅ 正确的错误处理（倒叙撤销）<div id=-正确的错误处理倒叙撤销 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e6%ad%a3%e7%a1%ae%e7%9a%84%e9%94%99%e8%af%af%e5%a4%84%e7%90%86%e5%80%92%e5%8f%99%e6%92%a4%e9%94%80 aria-label=Anchor>#</a></span></h4><ul><li><strong>第三关失败时</strong>：你不能直接回家。你必须<strong>倒着走回去</strong>。</li><li><strong>处理</strong>：<ol><li>先去第二关，注销身份。</li><li>再去第一关，退还通行证。</li><li>最后才能回家报错。</li></ol></li></ul><hr><h3 class="relative group">🛠️ 为什么要用 <code>goto</code>？<div id=-为什么要用-goto class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e7%94%a8-goto aria-label=Anchor>#</a></span></h3><p>在 C 语言里，如果有 5 个步骤，用 <code>if-else</code> 层层嵌套会写出“代码金字塔”，非常难看且容易出错。
Linux 内核约定俗成：<strong>使用 <code>goto</code> 语句跳转到统一的错误处理代码段</strong>。</p><p><strong>核心口诀：先进后出（FILO）</strong></p><ul><li>第 1 个申请的资源，要在 <strong>最倒霉</strong>（最后一步才出错）的时候才释放，所以它的释放代码放在最下面。</li><li>第 3 个申请的资源，如果在第 4 步出错，它是第一个需要被释放的。</li></ul><hr><h3 class="relative group">💻 代码实战：带错误处理的驱动框架<div id=-代码实战带错误处理的驱动框架 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e4%bb%a3%e7%a0%81%e5%ae%9e%e6%88%98%e5%b8%a6%e9%94%99%e8%af%af%e5%a4%84%e7%90%86%e7%9a%84%e9%a9%b1%e5%8a%a8%e6%a1%86%e6%9e%b6 aria-label=Anchor>#</a></span></h3><p>请仔细看下面代码中的注释，特别是 <code>goto</code> 跳转的位置和标号的顺序。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/init.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/module.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/fs.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/cdev.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/device.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/err.h&gt; // 必须包含，用于 IS_ERR 和 PTR_ERR</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>dev_t</span> <span class=n>dev_num</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>cdev</span> <span class=n>my_cdev</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>class</span> <span class=o>*</span><span class=n>my_class</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>device</span> <span class=o>*</span><span class=n>my_device</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>__init</span> <span class=nf>my_driver_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// --- 第一关：申请设备号 ---
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>alloc_chrdev_region</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dev_num</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=s>&#34;error_test_dev&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;第一关失败：申请设备号挂了</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 第一关就挂了，之前啥也没干，直接返回错误，不需要 goto
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// --- 第二关：注册 cdev ---
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>cdev_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_cdev</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span> <span class=c1>// 这里省略fops仅做演示
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>cdev_add</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_cdev</span><span class=p>,</span> <span class=n>dev_num</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;第二关失败：cdev注册挂了</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 这里失败了，需要把第一关申请的设备号还回去
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>goto</span> <span class=n>free_dev_num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// --- 第三关：创建类 ---
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>my_class</span> <span class=o>=</span> <span class=nf>class_create</span><span class=p>(</span><span class=n>THIS_MODULE</span><span class=p>,</span> <span class=s>&#34;test_class&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 注意：class_create 返回的是指针，判断指针错误要用 IS_ERR
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>IS_ERR</span><span class=p>(</span><span class=n>my_class</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;第三关失败：创建类挂了</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=nf>PTR_ERR</span><span class=p>(</span><span class=n>my_class</span><span class=p>);</span> <span class=c1>// 把指针错误转换成错误码(int)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 这里失败了，要撤销第二关(cdev)和第一关(设备号)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>goto</span> <span class=n>del_cdev</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// --- 第四关：创建设备节点 ---
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>my_device</span> <span class=o>=</span> <span class=nf>device_create</span><span class=p>(</span><span class=n>my_class</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=n>dev_num</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=s>&#34;test_device&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>IS_ERR</span><span class=p>(</span><span class=n>my_device</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;第四关失败：创建设备节点挂了</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=nf>PTR_ERR</span><span class=p>(</span><span class=n>my_device</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 这里失败了，要撤销第三关(类)、第二关(cdev)、第一关(设备号)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>goto</span> <span class=n>destroy_class</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;恭喜！所有关卡全部通过！</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ===========================================
</span></span></span><span class=line><span class=cl><span class=c1>// 下面是“倒叙”的错误处理区
</span></span></span><span class=line><span class=cl><span class=c1>// ===========================================
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nl>destroy_class</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 撤销第三关
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>class_destroy</span><span class=p>(</span><span class=n>my_class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>del_cdev</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 撤销第二关
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>cdev_del</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_cdev</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>free_dev_num</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 撤销第一关
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>unregister_chrdev_region</span><span class=p>(</span><span class=n>dev_num</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 返回错误码给内核，告诉它加载失败
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=n>__exit</span> <span class=nf>my_driver_exit</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 正常卸载时的顺序，和错误处理是一样的：倒着拆
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>device_destroy</span><span class=p>(</span><span class=n>my_class</span><span class=p>,</span> <span class=n>dev_num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>class_destroy</span><span class=p>(</span><span class=n>my_class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>cdev_del</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_cdev</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>unregister_chrdev_region</span><span class=p>(</span><span class=n>dev_num</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;驱动安全卸载</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>module_init</span><span class=p>(</span><span class=n>my_driver_init</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>module_exit</span><span class=p>(</span><span class=n>my_driver_exit</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>MODULE_LICENSE</span><span class=p>(</span><span class=s>&#34;GPL&#34;</span><span class=p>);</span>
</span></span></code></pre></div><hr><h3 class="relative group">🔍 关键知识点解释<div id=-关键知识点解释 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e5%85%b3%e9%94%ae%e7%9f%a5%e8%af%86%e7%82%b9%e8%a7%a3%e9%87%8a aria-label=Anchor>#</a></span></h3><ol><li><p><strong>标签（Label）命名规范</strong>：</p><ul><li>标签名通常代表**“在这个地方要做什么清理工作”**。</li><li>例如 <code>destroy_class:</code> 意味着跳到这里是为了销毁 class。</li><li>也有人喜欢命名为 <code>err_step3</code>，看个人习惯，建议用动词更清晰。</li></ul></li><li><p><strong>执行流（瀑布流）</strong>：</p><ul><li>注意看 <code>destroy_class:</code> 下面<strong>没有 <code>break</code> 也没有 <code>return</code></strong>。</li><li>这意味着，如果代码跳到了 <code>destroy_class</code>，它执行完 <code>class_destroy</code> 后，会<strong>接着往下执行</strong> <code>del_cdev</code>，再接着执行 <code>free_dev_num</code>。</li><li>这正是我们想要的！因为如果在第 4 步出错，第 3、2、1 步申请的资源都需要释放。</li></ul></li><li><p><strong>IS_ERR 和 PTR_ERR</strong>：</p><ul><li>有些函数（如 <code>class_create</code>）返回的是指针。如果失败了，它不会返回 <code>NULL</code>，而是返回一个特殊的“错误指针”（比如地址 0xFFFFFFF0）。</li><li><strong>判断方法</strong>：必须用 <code>IS_ERR(ptr)</code> 来判断是否出错。</li><li><strong>获取错误码</strong>：必须用 <code>PTR_ERR(ptr)</code> 把这个指针翻译成 <code>-ENOMEM</code> 之类的整数错误码返回给 <code>ret</code>。</li><li>(原因)传递真相：上层系统（比如 insmod 命令）接收到 ret 返回的 -12 后，它会查表，然后并在屏幕上打印出精美的报错信息：&ldquo;Out of memory&rdquo;（而不是仅仅显示“加载失败”）。</li><li>类型转换：my_class 是指针变量，ret 是整数变量。C 语言中，指针不能直接赋值给整数，必须通过 PTR_ERR 进行强制类型转换并还原数值。</li></ul></li></ol><h3 class="relative group">🚀 总结<div id=-总结 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-%e6%80%bb%e7%bb%93 aria-label=Anchor>#</a></span></h3><p>这一节的核心就是学会写**“后悔药”**：
<strong>只要前面的步骤成功了，当前步骤失败了，就必须用 <code>goto</code> 跳到对应的错误处理段，把之前吃进去的资源全部吐出来。</strong></p><hr><strong class="block mt-8"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:ryc1819009649@163.com?subject=Reply%20to%20Linux%e9%a9%b1%e5%8a%a8%e5%bc%80%e5%8f%91%20%e5%ad%97%e7%ac%a6%e8%ae%be%e5%a4%87">Reply by Email</a></strong></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_notes/Linux驱动开发_字符设备.md data-oid-likes=likes_notes/Linux驱动开发_字符设备.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/notes/linux%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91_%E5%85%A5%E9%97%A8%E7%AF%87/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;Linux驱动开发 入门篇
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-11-11T19:17:40+08:00>11 November 2025</time>
</span></span><span class="flex flex-col items-end"><a class="flex text-right text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/notes/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8_led/><span class=leading-6>字符设备驱动 LED&ensp;<span class="inline-block rtl:rotate-180">&rarr;</span>
</span></a><span class="me-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-11-24T20:50:51+08:00>24 November 2025</time></span></span></div></div></footer></article><div id=scroll-to-top class="fixed bottom-24 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">© 2025-2025 Can. All rights reserved.</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://rycCJ.github.io/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>